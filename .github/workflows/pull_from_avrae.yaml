name: Pull changes from Avrae

on:
  workflow_call:
    inputs:
      collections:
        description: Relative path to a JSON file containing a JSON object mapping relative directory paths in the repo to Avrae collection ids.
        default: collections.json
        required: false
        type: string
      gvars:
        description: Relative path to a JSON file containing a JSON object mapping Avrae gvar ids to descriptive names.
        default: gvars.json
        required: false
        type: string
    secrets:
      avrae_token:
        description: An authentication token from https://avrae.io/dashboard
        required: true

jobs:
  deploy_changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: Dintanthrir/avrae-autoupdate/actions/pull@add_github_workflows
        with:
          collections: ${{ inputs.collections }}
          gvars: ${{ inputs.gvars }}
          avrae_token: ${{ secrets.avrae_token }}
      - name: Create a pull request with any changes
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Changes pulled from Avrae ${{ github.event.repository.updated_at }}
          branch: pull-changes-from-avrae
          delete-branch: true
          title: Updates from Avrae
          body: Update local files to match changes found on the Avrae dashboard.
          add-paths: |
            *.alias
            *.snippet
            *.gvar
            *.md
      - name: Report pull request results
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Updates are available in ${{ steps.cpr.outputs.pull-request-url }}"